"""ì¬ë¬´ì œí‘œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

ì´ ëª¨ë“ˆì€ ì¬ë¬´ì œí‘œì™€ ì‚¬ì—…ë³´ê³ ì„œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
"""

from typing import Any, Dict, List

# ì¬ë¬´ì œí‘œ ë¶„ì„ í”„ë¡¬í”„íŠ¸
REVENUE_BREAKDOWN_USER_PROMPT = """
ì˜¤ëŠ˜ ë‚ ì§œ: {today_date}
ì§ˆë¬¸: {query}
ì¢…ëª©ì½”ë“œ: {stock_code}
ì¢…ëª©ëª…: {stock_name}

ì•„ë˜ëŠ” PDFì—ì„œ ì¶”ì¶œí•œ ì¬ë¬´ì œí‘œ ë° ì‚¬ì—…ë³´ê³ ì„œ ê´€ë ¨ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”:

{revenue_breakdown_data}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ëŒ€í•œ ì „ë¬¸ì ì´ê³  ì²´ê³„ì ì¸ ì¬ë¬´ ë¶„ì„ì„ ì œê³µí•˜ì„¸ìš”.

"""


REVENUE_BREAKDOWN_SYSTEM_PROMPT2 = """
ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜ (ì£¼ìš” ê±°ë˜ì²˜, ì£¼ìš” ê³ ê°)
2. ìˆ˜ì£¼ í˜„í™© (ê³„ì•½, ìˆ˜ì£¼ ì”ê³  ë“±)
3. ìˆ˜ì£¼ í˜„í™©ì˜ ë¶„ê¸°ë³„ í˜„í™©
4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™©
  - ê¸°ë³¸ ë‹¨ìœ„ëŠ” ì–µì›ì…ë‹ˆë‹¤.
  - í…Œì´ë¸”ì˜ ë‹¨ìœ„ê°€ ë°±ë§Œì›ì¸ ê²½ìš°, ì–µì› ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì„¸ìš”.
  - ë‹¨ìœ„ ë³€í™˜ ì‹œ, ë³€í™˜ ê³¼ì •ì„ ìƒì„¸íˆ ê¸°ë¡í•˜ì„¸ìš”.
5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™©
6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©
7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ì˜ ë¹„ìœ¨, %)

**ì¤‘ìš”: ë‹¨ìœ„ í‘œì‹œ**
- ì‚¬ì—…ë³´ê³ ì„œì—ëŠ” ëŒ€ë¶€ë¶„ ëˆ„ì  í˜•íƒœ(YTD)ë¡œ ë°ì´í„°ê°€ ì œê³µë©ë‹ˆë‹¤.
- 'ë°˜ê¸°' = '2ë¶„ê¸°', ì˜ˆ) 2024ë…„ ë°˜ê¸° -> 2024ë…„ 2ë¶„ê¸°
- ëª¨ë“  ë¶„ê¸°ì˜ ê°’ì€ ëˆ„ì ê°’ì´ë©°, ì´ ê°’ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.

**ë‹¨ìœ„ ë³€í™˜ ì •í™•ë„ í–¥ìƒì„ ìœ„í•œ ì§€ì¹¨:**
- ì…ë ¥ ë°ì´í„°ê°€ **ë°±ë§Œì›** ë‹¨ìœ„ì¼ ë•Œ, **ì–µì›** ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ëŠ” ê³µì‹: **ë°±ë§Œì› Ã· 100 = ì–µì›**

**ë°±ë§Œì› â†’ ì–µì› ë³€í™˜ ì˜ˆì‹œ:**
- 13,254 ë°±ë§Œì› Ã· 100 = 132.5ì–µì›
- 627,178 ë°±ë§Œì› Ã· 100 = 6,272ì–µì›
- 5,000 ë°±ë§Œì› Ã· 100 = 50ì–µì›

**ê¸°íƒ€ ë‹¨ìœ„ ë³€í™˜ ì˜ˆì‹œ:**
- 1,200 ì‹­ì–µì› Ã· 100 = 1.2ì¡°ì›
- 10,000 ë°±ë§Œì› Ã· 100 = 100ì–µì›

**ì¤‘ìš” ì£¼ì˜ì‚¬í•­:**
- ë°±ë§Œì›ì„ ì–µì›ìœ¼ë¡œ ë³€í™˜í•  ë•ŒëŠ” **Ã· 100**ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.
- ê³±ì…ˆ(Ã—)ì„ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. ë‚˜ëˆ—ì…ˆ(Ã·)ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
- ë‹¨ìœ„ ë³€í™˜ ì‹œ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ í‘œì‹œí•˜ì„¸ìš”.

**ğŸ’­ ë‹¨ìœ„ ë³€í™˜ ì‹œ ìƒê° ê³¼ì • ê¸°ë¡ í•„ìˆ˜:**
- ë‹¨ìœ„ ë³€í™˜ì„ í•  ë•Œë§ˆë‹¤ ë°˜ë“œì‹œ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ê³„ì‚° ê³¼ì •ì„ ê¸°ë¡í•˜ì„¸ìš”:

```
[ë‹¨ìœ„ ë³€í™˜ ê³¼ì •]
- ì›ë³¸ ë°ì´í„°: 13,254 (ë°±ë§Œì›)
- ì ìš© ê³µì‹: ë°±ë§Œì› Ã· 100 = ì–µì›
- ê³„ì‚° ê³¼ì •: 13,254 Ã· 100 = 132.54
- ìµœì¢… ê²°ê³¼: 132.54ì–µì›
```

- ì—¬ëŸ¬ ê°’ì„ ë³€í™˜í•  ë•ŒëŠ” ê°ê°ì˜ ë³€í™˜ ê³¼ì •ì„ ëª…ì‹œí•˜ì„¸ìš”.
- ë³€í™˜ëœ ê°’ì´ ì œëŒ€ë¡œ ì´ë£¨ì–´ì¡ŒëŠ”ì§€ ë‹¤ì‹œ í•œë²ˆ ê²€ì¦í•˜ì„¸ìš”.

**ìš”ì²­ ì‚¬í•­:**
- ìœ„ ì •ë³´ë¥¼ ê°„ê²°í•œ **í‘œ** í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
- ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.
- í•­ëª© 4~6ë²ˆì€ ê°ê° ë³„ë„ì˜ í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
- í•­ëª© 7ë²ˆì€ í•­ëª© 4ë²ˆì˜ ë§¤ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¤‘ì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.
- 4~6ë²ˆ í‘œëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”:

[ğŸ“Š í‘œ ì˜ˆì‹œ: ì œí’ˆë³„ ë§¤ì¶œ(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ë‚˜ë™ì„  | ì•Œë£¨ë¯¸ëŠ„ | ë‚´ìˆ˜ |
|------|--------|-----------|--------|
| 24.1Q | 470,626 | 220,000 | 110,000 |
| 24.2Q | 196,472 | 30,000 | 20,000 |
| 24.3Q | 244,279 | 35,000 | 20,000 |

[ğŸ“Š í‘œ ì˜ˆì‹œ: ìˆ˜ì£¼ì”ê³  í˜„í™©(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ëˆ„ì  ìˆ˜ì£¼ì”ê³  | ë¶„ê¸°ë³„ ìˆ˜ì£¼ì”ê³  |
|------|-------------|-------------------|
| 24.1Q | 1,500,000 | 1,500,000 |
| 24.2Q | 2,700,000 | 1,200,000 |
| 24.3Q | 3,500,000 | 800,000 |

[ğŸ“ˆ í‘œ ì˜ˆì‹œ: ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘]

| ë¶„ê¸° | ì „ì„  | ì¤‘ì „ê¸° | ê¸°íƒ€ |
|------|------|--------|------|
| 24.1Q | 65.2% | 32.5% | 2.3% |
| 24.2Q | 66.1% | 31.4% | 2.5% |
| 24.3Q | 67.3% | 30.1% | 2.6% |

â€» ê¸ˆì•¡ ë‹¨ìœ„ëŠ” í…Œì´ë¸” ìƒë‹¨ì„ ì°¸ì¡°
â€» ë§¤ì¶œ ë¹„ì¤‘(%)ì€ ê° ë¶„ê¸° ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ ë¹„ìœ¨ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œì•¡ì´ ì—†ëŠ” í•­ëª©ì€ '-'ë¡œ í‘œê¸°í•´ì£¼ì„¸ìš”.
â€» ëŒ€ë¶€ë¶„ì˜ ê¸°ì—…ì€ 1ë¶„ê¸°(1Q)ê°€ ì²«ë¶„ê¸° ì…ë‹ˆë‹¤.
"""


REVENUE_BREAKDOWN_SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜ (ì£¼ìš” ê±°ë˜ì²˜, ì£¼ìš” ê³ ê°)
2. ìˆ˜ì£¼ í˜„í™© (ê³„ì•½, ìˆ˜ì£¼ ì”ê³  ë“±)
3. ìˆ˜ì£¼ í˜„í™©ì˜ ë¶„ê¸°ë³„ í˜„í™©
4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™©
5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™©
6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©
7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ì˜ ë¹„ìœ¨, %)

**ìš”ì²­ ì‚¬í•­:**

- ìœ„ ì •ë³´ë¥¼ ê°„ê²°í•œ **í‘œ** í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
- ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.
- ì—°ê²°ê¸°ì¤€ ë°ì´í„°ì™€ ë³„ë„ê¸°ì¤€ ë°ì´í„° ì¤‘ ì—°ê²°ê¸°ì¤€ì„ ìš°ì„ ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. 
- ì‚¬ìš©ìì˜ ìš”ì²­ì´ ëª…ì‹œì ìœ¼ë¡œ ë³„ë„ê¸°ì¤€ ë°ì´í„°ë¥¼ ìš”ì²­í•œë‹¤ë©´, ë³„ë„ê¸°ì¤€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- í•­ëª© 4~6ë²ˆì€ ê°ê° ë‹¤ë¥¸ í…Œì´ë¸”ë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
- í•­ëª© 7ë²ˆì€ í•­ëª© 4ë²ˆì˜ ë§¤ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¤‘ì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.
- 4~6ë²ˆ í‘œëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”:
- ìµœê·¼ 4ê°œ ë¶„ê¸° ë°ì´í„°ë¥¼ ì¶œë ¥í•©ë‹ˆë‹¤.

[ğŸ“Š í‘œ ì˜ˆì‹œ: ì œí’ˆë³„ ë§¤ì¶œ(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ë‚˜ë™ì„  | ì•Œë£¨ë¯¸ëŠ„ | ë‚´ìˆ˜ |
|------|--------|-----------|--------|
| 24.3Q | 470,626 | 220,000 | 110,000 |
| 24.4Q | 196,472 | 30,000 | 20,000 |
| 25.1Q | 244,279 | 35,000 | 20,000 |

[ğŸ“Š í‘œ ì˜ˆì‹œ: ìˆ˜ì£¼ì”ê³  í˜„í™©(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ëˆ„ì  ìˆ˜ì£¼ì”ê³  | ë¶„ê¸°ë³„ ìˆ˜ì£¼ì”ê³  |
|------|-------------|-------------------|
| 24.3Q | 1,500,000 | 1,500,000 |
| 24.4Q | 2,700,000 | 1,200,000 |
| 25.1Q | 3,500,000 | 800,000 |

[ğŸ“ˆ í‘œ ì˜ˆì‹œ: ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘]

| ë¶„ê¸° | ì „ì„  | ì¤‘ì „ê¸° | ê¸°íƒ€ |
|------|------|--------|------|
| 24.3Q | 65.2% | 32.5% | 2.3% |
| 24.4Q | 66.1% | 31.4% | 2.5% |
| 25.1Q | 67.3% | 30.1% | 2.6% |

â€» ê¸ˆì•¡ ë‹¨ìœ„ëŠ” í…Œì´ë¸” ìƒë‹¨ì„ ì°¸ì¡°
â€» ë§¤ì¶œ ë¹„ì¤‘(%)ì€ ê° ë¶„ê¸° ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ ë¹„ìœ¨ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œì•¡ì´ ì—†ëŠ” í•­ëª©ì€ '-'ë¡œ í‘œê¸°í•´ì£¼ì„¸ìš”.
â€» ëŒ€ë¶€ë¶„ì˜ ê¸°ì—…ì€ 1ë¶„ê¸°(1Q)ê°€ ì²«ë¶„ê¸° ì…ë‹ˆë‹¤.
"""


def format_revenue_breakdown_data(formatted_data: List[Dict[str, Any]]) -> str:
    """ì¬ë¬´ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.

    Args:
        financial_data: ì¬ë¬´ ë°ì´í„° ë¦¬ìŠ¤íŠ¸

    Returns:
        str: í¬ë§·íŒ…ëœ ì¬ë¬´ ë°ì´í„° ë¬¸ìì—´
    """
    if not formatted_data:
        print("[FIN_FORMAT] ì…ë ¥ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
        return "ì¬ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."

    # ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬ë³¸ ìƒì„±
    result_strings = []

    for idx, item in enumerate(formatted_data):
        # ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
        if isinstance(item, str):
            result_strings.append(item)
            continue

        # ë”•ì…”ë„ˆë¦¬ê°€ ì•„ë‹Œ ê²½ìš° ê±´ë„ˆë›°ê¸°
        if not isinstance(item, dict):
            print(f"[FIN_FORMAT] ê²½ê³ : ì˜ëª»ëœ ë°ì´í„° íƒ€ì…: {type(item)} (ì¸ë±ìŠ¤ {idx})")
            continue

        # í•„ìš”í•œ ê°’ ì¶”ì¶œ
        source = item.get("source", "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜")
        date = item.get("date", "ë‚ ì§œ ì—†ìŒ")
        content = item.get("content", "")
        indicators = item.get("financial_indicators", {})

        data_str = f"[ì¶œì²˜: {source} ({date})]\n"

        # ì£¼ìš” ì¬ë¬´ ì§€í‘œê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
        if indicators:
            data_str += "\n## ì£¼ìš” ì¬ë¬´ ì§€í‘œ ê´€ë ¨ í…ìŠ¤íŠ¸:\n"
            for key, value in indicators.items():
                data_str += f"\n### {key}:\n{value}\n"

        # ë³´ê³ ì„œ ë‚´ìš© ì¶”ê°€
        data_str += f"\n## ë³´ê³ ì„œ ë³¸ë¬¸:\n{content}\n"

        # ê²°ê³¼ ë¬¸ìì—´ ëª©ë¡ì— ì¶”ê°€ (ì›ë³¸ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ)
        result_strings.append(data_str)

    print(f"[FIN_FORMAT] ê²°ê³¼ ë¬¸ìì—´ ìˆ˜: {len(result_strings)}")
    result = "\n\n===== ë³´ê³ ì„œ êµ¬ë¶„ì„  =====\n\n".join(result_strings)
    print(f"[FIN_FORMAT] ë°˜í™˜ë˜ëŠ” ìµœì¢… ë¬¸ìì—´ ê¸¸ì´: {len(result)}")

    # ëª¨ë“  í¬ë§·íŒ…ëœ ë¬¸ìì—´ì„ êµ¬ë¶„ì„ ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ë°˜í™˜
    return result
