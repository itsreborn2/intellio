# 에이전트 진행 상태 스트리밍 구현

이 문서는 사용자 질문에 대한 에이전트 처리 과정을 스트리밍 방식으로 클라이언트에 실시간 전송하는 기능의 구현 방법을 설명합니다.

## 구현 내용

Server-Sent Events(SSE)를 사용하여 각 에이전트의 처리 진행 상태를 실시간으로 클라이언트에 스트리밍하는 기능을 구현했습니다.

## 구현 단계

### 1. 백엔드 구현 - ✅ 완료

1. FastAPI에 새로운 스트리밍 엔드포인트 추가
   - `/api/v1/stockeasy/chat/sessions/{chat_session_id}/messages/stream` 경로에 SSE 스트리밍 엔드포인트 생성
   - `sse_starlette.sse` 모듈의 `EventSourceResponse` 사용

2. 그래프 실행 상태 추적 기능 구현
   - `StockAnalysisGraph` 클래스에 `current_state` 변수 추가로 세션별 상태 추적
   - 에이전트 래퍼 함수에 상태 업데이트 로직 추가 (시작, 진행, 완료 등)
   - 비동기 락(`asyncio.Lock`) 사용하여 동시성 제어

3. 에이전트 콜백 시스템 확장
   - 기존 콜백 시스템에 그래프 시작/종료 이벤트 추가
   - 콜백 함수가 비동기 함수인 경우 처리 로직 추가

### 2. 프론트엔드 구현 - ✅ 완료

1. API 서비스에 스트리밍 기능 추가
   - `streamChatMessage` 함수 구현하여 SSE 연결 및 이벤트 처리
   - 다양한 이벤트 타입에 대한 콜백 함수 지원 (시작, 에이전트 상태 변경, 에이전트 시작/완료, 완료, 오류)

2. 채팅 UI 컴포넌트 수정 (AIChatArea)
   - 메시지 타입에 '상태' 메시지 추가
   - 상태 메시지 렌더링 로직 추가
   - 기존 메시지 전송 대신 스트리밍 API 호출

## 데이터 흐름

1. 사용자가 질문을 입력하고 전송
2. 프론트엔드에서 streamChatMessage API 호출
3. 백엔드에서 사용자 메시지 저장 후 SSE 연결 설정
4. 백엔드에서 에이전트 그래프 실행 시작
5. 각 에이전트의 처리 시작/종료 시점에 SSE 이벤트 전송
6. 프론트엔드에서 이벤트를 받아 UI 업데이트
7. 최종 응답이 완료되면 complete 이벤트 전송

## 테스트 방법

1. 서버 실행
   ```
   cd backend
   python -m uvicorn stockeasy.main:app --reload
   ```

2. 클라이언트 실행
   ```
   cd frontend/stockeasy
   npm run dev
   ```

3. 웹 브라우저에서 애플리케이션 접속 후 로그인

4. 채팅 화면에서 종목 선택 후 질문 입력
   - 예: "엑스코프리 미국 시장 점유율 추이와 올해 실적은?"

5. 개발자 도구 콘솔에서 SSE 이벤트 확인 가능

## 추가 개선 사항

1. 에러 처리 강화
   - 네트워크 연결 끊김 처리
   - 타임아웃 설정

2. UI/UX 개선
   - 에이전트별 진행 상태 시각화
   - 진행 단계별 애니메이션 추가

3. 성능 최적화
   - 불필요한 이벤트 전송 줄이기
   - 메모리 사용량 모니터링 