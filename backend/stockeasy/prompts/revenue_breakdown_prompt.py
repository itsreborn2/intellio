"""ì¬ë¬´ì œí‘œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

ì´ ëª¨ë“ˆì€ ì¬ë¬´ì œí‘œì™€ ì‚¬ì—…ë³´ê³ ì„œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
"""

from typing import List, Dict, Any

# ì¬ë¬´ì œí‘œ ë¶„ì„ í”„ë¡¬í”„íŠ¸
REVENUE_BREAKDOWN_USER_PROMPT = """
ì§ˆë¬¸: {query}
ì¢…ëª©ì½”ë“œ: {stock_code}
ì¢…ëª©ëª…: {stock_name}

ì•„ë˜ëŠ” PDFì—ì„œ ì¶”ì¶œí•œ ì¬ë¬´ì œí‘œ ë° ì‚¬ì—…ë³´ê³ ì„œ ê´€ë ¨ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”:

{revenue_breakdown_data}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ëŒ€í•œ ì „ë¬¸ì ì´ê³  ì²´ê³„ì ì¸ ì¬ë¬´ ë¶„ì„ì„ ì œê³µí•˜ì„¸ìš”.

"""

REVENUE_BREAKDOWN_SYSTEM_PROMPT2 = """
ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜ (ì£¼ìš” ê±°ë˜ì²˜, ì£¼ìš” ê³ ê°)
2. ìˆ˜ì£¼ í˜„í™© (ê³„ì•½, ìˆ˜ì£¼ ì”ê³  ë“±)
3. ìˆ˜ì£¼ í˜„í™©ì˜ ë¶„ê¸°ë³„ í˜„í™©
4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™©
5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™©
6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©
7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ì˜ ë¹„ìœ¨, %)

**ìš”ì²­ ì‚¬í•­:**
- ìœ„ ì •ë³´ë¥¼ ê°„ê²°í•œ **í‘œ** í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
- ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.
- í•­ëª© 4~6ë²ˆì€ ê°ê° ë³„ë„ì˜ í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
- í•­ëª© 7ë²ˆì€ í•­ëª© 4ë²ˆì˜ ë§¤ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¤‘ì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.
- 4~6ë²ˆ í‘œëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”:

[ğŸ“Š í‘œ ì˜ˆì‹œ: ì œí’ˆë³„ ë§¤ì¶œ]

| ë¶„ê¸° | ë‚˜ë™ì„  | ì•Œë£¨ë¯¸ëŠ„ | ë‚´ìˆ˜ |
|------|--------|-----------|--------|
| 2024.1Q | 470,626 | 220,000 | 110,000 |
| 2024.2Q | 667,098 | 250,000 | 130,000 |
| 2024.3Q | 911,377 | 285,000 | 150,000 |

[ğŸ“ˆ í‘œ ì˜ˆì‹œ: ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘]

| ë¶„ê¸° | ì „ì„  | ì¤‘ì „ê¸° | ê¸°íƒ€ |
|------|------|--------|------|
| 2024.1Q | 65.2% | 32.5% | 2.3% |
| 2024.2Q | 66.1% | 31.4% | 2.5% |
| 2024.3Q | 67.3% | 30.1% | 2.6% |

â€» ëª¨ë“  ê¸ˆì•¡ ë‹¨ìœ„ëŠ” **ë°±ë§Œì›**ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œ ë¹„ì¤‘(%)ì€ ê° ë¶„ê¸° ì´ ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ ë¹„ìœ¨ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œì•¡ì´ ì—†ëŠ” í•­ëª©ì€ '-'ë¡œ í‘œê¸°í•´ì£¼ì„¸ìš”.
"""

REVENUE_BREAKDOWN_SYSTEM_PROMPT3 = """
ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜ (ì£¼ìš” ê±°ë˜ì²˜, ì£¼ìš” ê³ ê°)
2. ìˆ˜ì£¼ í˜„í™© (ê³„ì•½, ìˆ˜ì£¼ ì”ê³  ë“±)
3. ìˆ˜ì£¼ í˜„í™©ì˜ ë¶„ê¸°ë³„ í˜„í™©
4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™©
5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™©
6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©
7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ì˜ ë¹„ìœ¨, %)

**ì¤‘ìš”: ë‹¨ìœ„ í‘œì‹œ**
- ì‚¬ì—…ë³´ê³ ì„œì—ëŠ” ëŒ€ë¶€ë¶„ ëˆ„ì  í˜•íƒœ(YTD)ë¡œ ë°ì´í„°ê°€ ì œê³µë©ë‹ˆë‹¤.
- 'ë°˜ê¸°' = '2ë¶„ê¸°', ì˜ˆ) 2024ë…„ ë°˜ê¸° -> 2024ë…„ 2ë¶„ê¸°
- ì²« ë¶„ê¸°(1Q)ì˜ ê²½ìš°ëŠ” ëˆ„ì ê°’ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ë‹¨ìœ„ëŠ” ê¸°ë³¸ (ì–µì›) ë‹¨ìœ„ë¡œ í‘œì‹œí•˜ì„¸ìš”. 0.x ì–µì›ìœ¼ë¡œ í‘œì‹œë˜ì§€ ì•ŠëŠ” ì‘ì€ ìˆ«ìë¼ë©´, (ì²œì›) ë‹¨ìœ„ë¡œ í‘œì‹œ.
- ë‹¨ìœ„ê°€ (ì¡°ì›) ì´ìƒì´ë¼ë©´ (ì¡°ì›) ë‹¨ìœ„ë¡œ í‘œì‹œ.
- ì²œì› :    1,000ì›
- ë°±ë§Œì› : 1,000,000ì›
- ì–µì› : 100,000,000ì›
- ì‹­ì–µì› : 10,000,000,000ì›
- ì¡°ì› : 1,000,000,000,000ì›

**ë‹¨ìœ„ ë³€í™˜ ì •í™•ë„ í–¥ìƒì„ ìœ„í•œ ì§€ì¹¨:**
- ë‹¨ìœ„ ë³€í™˜ ì‹œ ë°˜ë“œì‹œ ê³±ì…ˆê³¼ ë‚˜ëˆ—ì…ˆì„ ì •í™•íˆ ìˆ˜í–‰í•˜ì„¸ìš”.
- ì˜ˆì‹œ 1: 200,000 ë°±ë§Œì› = 200,000 Ã— 1,000,000ì› = 200,000,000,000ì› = 200 ì‹­ì–µì› (ì •í™•í•œ ë³€í™˜)
- ì˜ˆì‹œ 2: 5,000 ë°±ë§Œì› = 5,000 Ã— 1,000,000ì› = 5,000,000,000ì› = 50ì–µì›
- ì˜ˆì‹œ 3: 1,200,000 ë°±ë§Œì› = 1,200,000 Ã— 1,000,000ì› = 1,200,000,000,000ì› = 1.2ì¡°ì›
- ë‹¨ìœ„ ë³€í™˜ ì‹œ ìˆ«ìê°€ 10ì˜ ìë¦¬ìˆ˜ì—ì„œ ì˜ëª» ê³„ì‚°ë˜ì§€ ì•Šë„ë¡ ìœ ì˜í•˜ì„¸ìš”.

**ìš”ì²­ ì‚¬í•­:**
- ìœ„ ì •ë³´ë¥¼ ê°„ê²°í•œ **í‘œ** í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
- ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.
- í•­ëª© 4~6ë²ˆì€ ê°ê° ë³„ë„ì˜ í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
- í•­ëª© 7ë²ˆì€ í•­ëª© 4ë²ˆì˜ ë§¤ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¤‘ì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.
- 4~6ë²ˆ í‘œëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”:

[ğŸ“Š í‘œ ì˜ˆì‹œ: ì œí’ˆë³„ ë§¤ì¶œ(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ë‚˜ë™ì„  | ì•Œë£¨ë¯¸ëŠ„ | ë‚´ìˆ˜ |
|------|--------|-----------|--------|
| 24.1Q | 470,626 | 220,000 | 110,000 |
| 24.2Q | 196,472 | 30,000 | 20,000 |
| 24.3Q | 244,279 | 35,000 | 20,000 |

[ğŸ“Š í‘œ ì˜ˆì‹œ: ìˆ˜ì£¼ì”ê³  í˜„í™©(ë¶„ê¸°ë³„)]

| ë¶„ê¸° | ëˆ„ì  ìˆ˜ì£¼ì”ê³  | ë¶„ê¸°ë³„ ìˆ˜ì£¼ì”ê³  |
|------|-------------|-------------------|
| 24.1Q | 1,500,000 | 1,500,000 |
| 24.2Q | 2,700,000 | 1,200,000 |
| 24.3Q | 3,500,000 | 800,000 |

[ğŸ“ˆ í‘œ ì˜ˆì‹œ: ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘]

| ë¶„ê¸° | ì „ì„  | ì¤‘ì „ê¸° | ê¸°íƒ€ |
|------|------|--------|------|
| 24.1Q | 65.2% | 32.5% | 2.3% |
| 24.2Q | 66.1% | 31.4% | 2.5% |
| 24.3Q | 67.3% | 30.1% | 2.6% |

â€» ê¸ˆì•¡ ë‹¨ìœ„ëŠ” í…Œì´ë¸” ìƒë‹¨ì„ ì°¸ì¡°
â€» ë§¤ì¶œ ë¹„ì¤‘(%)ì€ ê° ë¶„ê¸° ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ ë¹„ìœ¨ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œì•¡ì´ ì—†ëŠ” í•­ëª©ì€ '-'ë¡œ í‘œê¸°í•´ì£¼ì„¸ìš”.
â€» ëŒ€ë¶€ë¶„ì˜ ê¸°ì—…ì€ 1ë¶„ê¸°(1Q)ê°€ ì²«ë¶„ê¸° ì…ë‹ˆë‹¤.
"""

def format_revenue_breakdown_data(formatted_data: List[Dict[str, Any]]) -> str:
    """ì¬ë¬´ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.

    Args:
        financial_data: ì¬ë¬´ ë°ì´í„° ë¦¬ìŠ¤íŠ¸

    Returns:
        str: í¬ë§·íŒ…ëœ ì¬ë¬´ ë°ì´í„° ë¬¸ìì—´
    """
    if not formatted_data:
        print("[FIN_FORMAT] ì…ë ¥ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
        return "ì¬ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    # ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬ë³¸ ìƒì„±
    result_strings = []
    
    for idx, item in enumerate(formatted_data):
            
        # ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
        if isinstance(item, str):
            result_strings.append(item)
            continue
            
        # ë”•ì…”ë„ˆë¦¬ê°€ ì•„ë‹Œ ê²½ìš° ê±´ë„ˆë›°ê¸°
        if not isinstance(item, dict):
            print(f"[FIN_FORMAT] ê²½ê³ : ì˜ëª»ëœ ë°ì´í„° íƒ€ì…: {type(item)} (ì¸ë±ìŠ¤ {idx})")
            continue
            
        # í•„ìš”í•œ ê°’ ì¶”ì¶œ
        source = item.get("source", "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜")
        date = item.get("date", "ë‚ ì§œ ì—†ìŒ")
        content = item.get("content", "")
        indicators = item.get("financial_indicators", {})
        
        data_str = f"[ì¶œì²˜: {source} ({date})]\n"
        
        # ì£¼ìš” ì¬ë¬´ ì§€í‘œê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
        if indicators:
            data_str += "\n## ì£¼ìš” ì¬ë¬´ ì§€í‘œ ê´€ë ¨ í…ìŠ¤íŠ¸:\n"
            for key, value in indicators.items():
                data_str += f"\n### {key}:\n{value}\n"
        
        # ë³´ê³ ì„œ ë‚´ìš© ì¶”ê°€
        data_str += f"\n## ë³´ê³ ì„œ ë³¸ë¬¸:\n{content}\n"
        
        # ê²°ê³¼ ë¬¸ìì—´ ëª©ë¡ì— ì¶”ê°€ (ì›ë³¸ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ)
        result_strings.append(data_str)
    
    print(f"[FIN_FORMAT] ê²°ê³¼ ë¬¸ìì—´ ìˆ˜: {len(result_strings)}")
    result = "\n\n===== ë³´ê³ ì„œ êµ¬ë¶„ì„  =====\n\n".join(result_strings)
    print(f"[FIN_FORMAT] ë°˜í™˜ë˜ëŠ” ìµœì¢… ë¬¸ìì—´ ê¸¸ì´: {len(result)}")
    
    # ëª¨ë“  í¬ë§·íŒ…ëœ ë¬¸ìì—´ì„ êµ¬ë¶„ì„ ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ë°˜í™˜
    return result
