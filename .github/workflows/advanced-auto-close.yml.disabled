name: Advanced Auto Close Issues

on:
  push:
    branches: [develop]

permissions:
  issues: write
  contents: read

jobs:
  close-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Close issues with advanced features
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = context.payload.commits || [];
            const closedIssues = [];
            
            console.log(`ðŸš€ Advanced Auto Close Issues started`);
            console.log(`ðŸ“¦ Processing ${commits.length} commits from develop branch`);
            
            for (const commit of commits) {
              const message = commit.message;
              console.log(`\nðŸ” Analyzing commit: ${commit.id.substring(0, 7)}`);
              console.log(`ðŸ“ Message: ${message}`);
              console.log(`ðŸ‘¤ Author: ${commit.author.name}`);
              
              // ë” ìœ ì—°í•œ íŒ¨í„´ ë§¤ì¹­ (í•œêµ­ì–´ + ì˜ì–´)
              const patterns = [
                // ì˜ì–´ íŒ¨í„´
                /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*:?\s*#(\d+)/gi,
                // í•œêµ­ì–´ íŒ¨í„´ (ì•žì— ì˜¤ëŠ” ê²½ìš°)
                /(?:í•´ê²°|ìˆ˜ì •|ì™„ë£Œ|ë‹«ê¸°)\s*:?\s*#(\d+)/gi,
                // í•œêµ­ì–´ íŒ¨í„´ (ï¿½ì— ì˜¤ëŠ” ê²½ìš°)
                /#(\d+)\s*(?:í•´ê²°|ìˆ˜ì •|ì™„ë£Œ|ë‹«ê¸°)/gi,
                // ì¶”ê°€ íŒ¨í„´
                /\b(?:bug|ë²„ê·¸)\s*(?:fix|ìˆ˜ì •)\s*:?\s*#(\d+)/gi
              ];
              
              for (const pattern of patterns) {
                let match;
                pattern.lastIndex = 0; // ì •ê·œì‹ ë¦¬ì…‹
                
                while ((match = pattern.exec(message)) !== null) {
                  const issueNumber = parseInt(match[1]);
                  
                  // ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
                  if (!closedIssues.includes(issueNumber)) {
                    console.log(`âœ… Found issue #${issueNumber} to close`);
                    
                    try {
                      // ì´ìŠˆ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                      const issue = await github.rest.issues.get({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: issueNumber
                      });
                      
                      if (issue.data.state === 'open') {
                        // ë¼ë²¨ ì¶”ê°€ (ì¡´ìž¬í•˜ì§€ ì•Šìœ¼ë©´ ë¬´ì‹œë¨)
                        try {
                          await github.rest.issues.addLabels({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            issue_number: issueNumber,
                            labels: ['auto-closed', 'develop-branch']
                          });
                          console.log(`ðŸ·ï¸ Added labels to issue #${issueNumber}`);
                        } catch (labelError) {
                          console.log(`âš ï¸ Could not add labels to issue #${issueNumber}: ${labelError.message}`);
                        }
                        
                        // ì´ìŠˆ ë‹«ê¸°
                        await github.rest.issues.update({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          state: 'closed'
                        });
                        
                        // ìƒì„¸ ì½”ë©˜íŠ¸ ì¶”ê°€
                        const commentBody = `## ðŸ¤– ìžë™ìœ¼ë¡œ ì´ìŠˆê°€ ë‹«í˜”ìŠµë‹ˆë‹¤

### ðŸ“‹ ì»¤ë°‹ ì •ë³´
- **ë¸Œëžœì¹˜**: \`develop\`
- **ì»¤ë°‹ ID**: \`${commit.id.substring(0, 7)}\`
- **ìž‘ì„±ìž**: ${commit.author.name}
- **ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}

### ðŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€
\`\`\`
${commit.message}
\`\`\`

### ðŸ“Š ì´ìŠˆ í†µê³„
- **ì›ëž˜ ìƒíƒœ**: ${issue.data.state}
- **ë¼ë²¨**: ${issue.data.labels.map(label => label.name).join(', ') || 'ì—†ìŒ'}
- **ë§ˆì¼ìŠ¤í†¤**: ${issue.data.milestone ? issue.data.milestone.title : 'ì—†ìŒ'}

### ðŸ”— ê´€ë ¨ ë§í¬
- [ì»¤ë°‹ ë³´ê¸°](${commit.url})
- [íŒŒì¼ ë³€ê²½ì‚¬í•­](${commit.url}/files)
- [ë¸Œëžœì¹˜ ížˆìŠ¤í† ë¦¬](https://github.com/${context.repo.owner}/${context.repo.repo}/commits/develop)

---
*ì´ ìž‘ì—…ì€ GitHub Actionsì˜ Advanced Auto Close ì›Œí¬í”Œë¡œìš°ì— ì˜í•´ ìžë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*
*ë¬¸ì œê°€ ìžˆë‹¤ë©´ ì´ìŠˆë¥¼ ë‹¤ì‹œ ì—´ê±°ë‚˜ ìƒˆë¡œìš´ ì´ìŠˆë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.*`;

                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issueNumber,
                          body: commentBody
                        });
                        
                        closedIssues.push(issueNumber);
                        console.log(`ðŸŽ‰ Successfully closed issue #${issueNumber}`);
                        
                      } else {
                        console.log(`â„¹ï¸ Issue #${issueNumber} is already ${issue.data.state}`);
                      }
                      
                    } catch (error) {
                      console.error(`âŒ Error processing issue #${issueNumber}:`, error.message);
                      
                      // ì—ëŸ¬ ìƒì„¸ ì •ë³´ ë¡œê¹…
                      if (error.status === 404) {
                        console.error(`   â†’ Issue #${issueNumber} not found`);
                      } else if (error.status === 403) {
                        console.error(`   â†’ Permission denied for issue #${issueNumber}`);
                      } else {
                        console.error(`   â†’ HTTP ${error.status}: ${error.message}`);
                      }
                    }
                  } else {
                    console.log(`â­ï¸ Issue #${issueNumber} already processed in this run`);
                  }
                }
              }
            }
            
            // ìš”ì•½ ì •ë³´ ì¶œë ¥
            console.log(`\nðŸ“ˆ SUMMARY`);
            console.log(`âœ¨ Total commits processed: ${commits.length}`);
            
            if (closedIssues.length > 0) {
              console.log(`ðŸŽ¯ Issues closed: #${closedIssues.join(', #')}`);
              console.log(`ðŸ† Successfully closed ${closedIssues.length} issue(s)`);
            } else {
              console.log(`ðŸ“ No issues found to close in commit messages`);
            }
            
            console.log(`\nâœ… Advanced Auto Close process completed successfully!`);

      - name: Create workflow summary
        if: always()
        run: |
          echo "## ðŸ¤– Auto Close Issues Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow**: Advanced Auto Close Issues" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: Push event" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Features" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Multi-language keyword support (Korean + English)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ·ï¸ Automatic label addition" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ’¬ Detailed comments on closed issues" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Comprehensive logging and error handling" >> $GITHUB_STEP_SUMMARY 