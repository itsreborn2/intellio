name: Auto Close Issues on Develop

on:
  push:
    branches: [develop]

jobs:
  close-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Close issues mentioned in commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = context.payload.commits || [];
            console.log(`ğŸš€ Processing ${commits.length} commits`);
            
            for (const commit of commits) {
              const message = commit.message;
              console.log(`\nğŸ” Checking commit: ${commit.id.substring(0, 7)}`);
              console.log(`ğŸ“ Message: ${message}`);
              
              // í•œêµ­ì–´ + ì˜ì–´ í‚¤ì›Œë“œ ì§€ì›
              const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?|í•´ê²°|ìˆ˜ì •|ì™„ë£Œ|ë‹«ê¸°)\s*:?\s*#(\d+)/gi;
              let match;
              
              while ((match = issuePattern.exec(message)) !== null) {
                const issueNumber = parseInt(match[1]);
                console.log(`âœ… Found issue #${issueNumber} to close`);
                
                try {
                  // ì´ìŠˆ ìƒíƒœ í™•ì¸
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  
                  if (issue.data.state === 'open') {
                    // ì´ìŠˆ ë‹«ê¸°
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      state: 'closed'
                    });
                    
                    // ì½”ë©˜íŠ¸ ì¶”ê°€
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `ğŸ¤– ì´ ì´ìŠˆëŠ” develop ë¸Œëœì¹˜ì˜ ì»¤ë°‹ì— ì˜í•´ ìë™ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤.

**ì»¤ë°‹ ì •ë³´:**
- ì»¤ë°‹ ID: ${commit.id.substring(0, 7)}
- ì»¤ë°‹ ë©”ì‹œì§€: ${commit.message}
- ì‘ì„±ì: ${commit.author.name}
- ì‹œê°„: ${new Date().toLocaleString('ko-KR')}

[ì»¤ë°‹ ë³´ê¸°](${commit.url})`
                    });
                    
                    console.log(`ğŸ‰ Successfully closed issue #${issueNumber}`);
                  } else {
                    console.log(`â„¹ï¸ Issue #${issueNumber} is already ${issue.data.state}`);
                  }
                } catch (error) {
                  console.error(`âŒ Failed to close issue #${issueNumber}:`, error.message);
                }
              }
            }
            
            console.log('\nâœ¨ Auto-close process completed'); 