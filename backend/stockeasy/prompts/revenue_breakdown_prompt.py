"""재무제표 분석을 위한 프롬프트 템플릿

이 모듈은 재무제표와 사업보고서 분석을 위한 프롬프트를 정의합니다.
"""

from typing import List, Dict, Any

# 재무제표 분석 프롬프트
REVENUE_BREAKDOWN_USER_PROMPT = """
질문: {query}
종목코드: {stock_code}
종목명: {stock_name}

아래는 PDF에서 추출한 재무제표 및 사업보고서 관련 텍스트입니다. 이 정보를 바탕으로 분석하세요:

{revenue_breakdown_data}

위 정보를 바탕으로 질문에 대한 전문적이고 체계적인 재무 분석을 제공하세요.

"""
REVENUE_BREAKDOWN_SYSTEM_PROMPT = """
당신은 기업 재무 분석 전문가입니다. 특히 매출 및 수주 현황 분석에 전문성이 있습니다.
주어진 사업보고서에서 다음 정보를 정확하게 추출하고 구조화하세요:

1. 주요 매출처:
   - '주요 매출처', '주요 거래처', '주요 고객' 등으로 명시된 항목
   - 매출액 또는 매출 비중이 함께 기재된 경우 같이 추출

2. 수주 현황:
   - '수주 현황', '수주 계약', '수주 잔고' 등의 섹션
   - 계약일자, 계약처, 계약내용, 계약금액, 납기일, 기납품액, 수주잔고 등 정보

3. 수주 현황 분기별 증감율:
   - 수주 잔고에 대한 분기별 증감률(QoQ)
   - 보고서에 직접적인 언급이 없으면 데이터로 계산 (가능 여부 명시)

4. 사업부문별 매출 현황 및 증감율:
   - '사업 부문별 현황', '부문별 재무 정보' 등에서 각 사업부문의 매출액
   - 분기별 증감률(QoQ) (계산 가능 여부 명시)

5. 제품별 매출 현황 및 증감율:
   - '주요 제품 및 서비스', '매출 실적' 등에서 제품별 매출액
   - 분기별 증감률(QoQ) (계산 가능 여부 명시)

6. 지역별 매출 현황 및 증감율:
   - '지역별 매출 현황', '수출/내수 비중' 등에서 지역별 매출액
   - 분기별 증감률(QoQ) (계산 가능 여부 명시)

7. 사업부문별 매출 비중:
   - 전체 매출액 대비 각 사업부문의 비율(%)
   - 직접적인 언급이 없으면 데이터로 계산 (가능 여부 명시)

보고서에서 관련 정보를 찾지 못한 경우, 해당 항목은 "정보 없음" 또는 "계산 불가"로 표시하세요.
계산이 필요한 경우 근거가 되는 수치와 계산 과정을 함께 제시하세요.
모든 금액에는 적절한 단위(억원, 백만원 등)를 명시하세요.
"""

REVENUE_BREAKDOWN_SYSTEM_PROMPT2 = """
당신은 기업 분석 전문가입니다. 주어진 사업보고서 내용을 분석하여 다음 정보를 표로 정리해주세요:

1. 주요 매출처 (주요 거래처, 주요 고객)
2. 수주 현황 (계약, 수주 잔고 등)
3. 수주 현황의 분기별 증감율 현황
4. 사업부문별 매출 현황과 지난 분기 대비 증감율(QoQ)
5. 제품별 매출 현황과 지난 분기 대비 증감율(QoQ)
6. 지역별 매출 현황과 지난 분기 대비 증감율(QoQ)
7. 사업부문별 매출 비중 (전체 매출 대비 각 사업부의 비율, %)

**요청 사항:**
- 위 정보를 간결한 **표** 형태로 정리해주세요.
- 정보가 없는 항목은 생략합니다.
- 항목 4~6번은 각각 별도의 표로 구분하여 작성해주세요.
- 항목 7번은 항목 4번의 매출을 기반으로 비중을 계산해주세요.
- 4~6번 표는 다음 형식으로 출력해주세요:

[📊 표 예시: 제품별 매출]

| 분기 | 나동선 | 알루미늄 | 내수 |
|------|--------|-----------|--------|
| 2024년 1분기 | 470,626 (5.2%) | 220,000 (2.1%) | 110,000 (3.5%) |
| 2024년 2분기 | 667,098 (11.3%) | 250,000 (13.6%) | 130,000 (18.2%) |
| 2024년 3분기 | 911,377 (10.1%) | 285,000 (9.2%) | 150,000 (15.4%) |

[📈 표 예시: 사업부문별 매출 비중]

| 분기 | 전선 | 중전기 | 기타 |
|------|------|--------|------|
| 2024년 1분기 | 65.2% | 32.5% | 2.3% |
| 2024년 2분기 | 66.1% | 31.4% | 2.5% |
| 2024년 3분기 | 67.3% | 30.1% | 2.6% |

※ 모든 금액 단위는 **백만원**, 괄호 안은 전 분기 대비 증감율(QoQ)입니다.
※ 매출 비중(%)은 각 분기 총 매출 기준으로 계산된 비율입니다.
※ 매출액이 없는 항목은 ‘-’로 표기해주세요.
"""

def format_revenue_breakdown_data(formatted_data: List[Dict[str, Any]]) -> str:
    """재무 데이터를 문자열로 포맷팅합니다.

    Args:
        financial_data: 재무 데이터 리스트

    Returns:
        str: 포맷팅된 재무 데이터 문자열
    """
    if not formatted_data:
        print("[FIN_FORMAT] 입력 데이터가 비어 있습니다.")
        return "재무 데이터가 없습니다."
    
    # 원본 데이터 보존을 위해 복사본 생성
    result_strings = []
    
    for idx, item in enumerate(formatted_data):
            
        # 문자열인 경우 그대로 추가
        if isinstance(item, str):
            result_strings.append(item)
            continue
            
        # 딕셔너리가 아닌 경우 건너뛰기
        if not isinstance(item, dict):
            print(f"[FIN_FORMAT] 경고: 잘못된 데이터 타입: {type(item)} (인덱스 {idx})")
            continue
            
        # 필요한 값 추출
        source = item.get("source", "알 수 없는 출처")
        date = item.get("date", "날짜 없음")
        content = item.get("content", "")
        indicators = item.get("financial_indicators", {})
        
        data_str = f"[출처: {source} ({date})]\n"
        
        # 주요 재무 지표가 있으면 먼저 표시
        if indicators:
            data_str += "\n## 주요 재무 지표 관련 텍스트:\n"
            for key, value in indicators.items():
                data_str += f"\n### {key}:\n{value}\n"
        
        # 보고서 내용 추가
        data_str += f"\n## 보고서 본문:\n{content}\n"
        
        # 결과 문자열 목록에 추가 (원본 데이터를 변경하지 않음)
        result_strings.append(data_str)
    
    print(f"[FIN_FORMAT] 결과 문자열 수: {len(result_strings)}")
    result = "\n\n===== 보고서 구분선 =====\n\n".join(result_strings)
    print(f"[FIN_FORMAT] 반환되는 최종 문자열 길이: {len(result)}")
    
    # 모든 포맷팅된 문자열을 구분선으로 연결하여 반환
    return result
