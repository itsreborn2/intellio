name: Auto Close Issues on Develop

on:
  push:
    branches: [develop]

jobs:
  close-issues:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Close issues mentioned in commits
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commits = context.payload.commits || [];
            console.log(`🚀 Processing ${commits.length} commits`);
            
            for (const commit of commits) {
              const message = commit.message;
              console.log(`\n🔍 Checking commit: ${commit.id.substring(0, 7)}`);
              console.log(`📝 Message: ${message}`);
              
              // 한국어 + 영어 키워드 지원
              const issuePattern = /(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?|해결|수정|완료|닫기)\s*:?\s*#(\d+)/gi;
              let match;
              
              while ((match = issuePattern.exec(message)) !== null) {
                const issueNumber = parseInt(match[1]);
                console.log(`✅ Found issue #${issueNumber} to close`);
                
                try {
                  // 이슈 상태 확인
                  const issue = await github.rest.issues.get({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber
                  });
                  
                  if (issue.data.state === 'open') {
                    // 이슈 닫기
                    await github.rest.issues.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      state: 'closed'
                    });
                    
                    // 코멘트 추가
                    await github.rest.issues.createComment({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      issue_number: issueNumber,
                      body: `🤖 이 이슈는 develop 브랜치의 커밋에 의해 자동으로 닫혔습니다.

**커밋 정보:**
- 커밋 ID: ${commit.id.substring(0, 7)}
- 커밋 메시지: ${commit.message}
- 작성자: ${commit.author.name}
- 시간: ${new Date().toLocaleString('ko-KR')}

[커밋 보기](${commit.url})`
                    });
                    
                    console.log(`🎉 Successfully closed issue #${issueNumber}`);
                  } else {
                    console.log(`ℹ️ Issue #${issueNumber} is already ${issue.data.state}`);
                  }
                } catch (error) {
                  console.error(`❌ Failed to close issue #${issueNumber}:`, error.message);
                }
              }
            }
            
            console.log('\n✨ Auto-close process completed'); 