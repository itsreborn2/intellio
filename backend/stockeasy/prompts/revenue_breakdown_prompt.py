"""ì¬ë¬´ì œí‘œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿

ì´ ëª¨ë“ˆì€ ì¬ë¬´ì œí‘œì™€ ì‚¬ì—…ë³´ê³ ì„œ ë¶„ì„ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.
"""

from typing import List, Dict, Any

# ì¬ë¬´ì œí‘œ ë¶„ì„ í”„ë¡¬í”„íŠ¸
REVENUE_BREAKDOWN_USER_PROMPT = """
ì§ˆë¬¸: {query}
ì¢…ëª©ì½”ë“œ: {stock_code}
ì¢…ëª©ëª…: {stock_name}

ì•„ë˜ëŠ” PDFì—ì„œ ì¶”ì¶œí•œ ì¬ë¬´ì œí‘œ ë° ì‚¬ì—…ë³´ê³ ì„œ ê´€ë ¨ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤. ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”:

{revenue_breakdown_data}

ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì§ˆë¬¸ì— ëŒ€í•œ ì „ë¬¸ì ì´ê³  ì²´ê³„ì ì¸ ì¬ë¬´ ë¶„ì„ì„ ì œê³µí•˜ì„¸ìš”.

"""
REVENUE_BREAKDOWN_SYSTEM_PROMPT = """
ë‹¹ì‹ ì€ ê¸°ì—… ì¬ë¬´ ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. íŠ¹íˆ ë§¤ì¶œ ë° ìˆ˜ì£¼ í˜„í™© ë¶„ì„ì— ì „ë¬¸ì„±ì´ ìˆìŠµë‹ˆë‹¤.
ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œì—ì„œ ë‹¤ìŒ ì •ë³´ë¥¼ ì •í™•í•˜ê²Œ ì¶”ì¶œí•˜ê³  êµ¬ì¡°í™”í•˜ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜:
   - 'ì£¼ìš” ë§¤ì¶œì²˜', 'ì£¼ìš” ê±°ë˜ì²˜', 'ì£¼ìš” ê³ ê°' ë“±ìœ¼ë¡œ ëª…ì‹œëœ í•­ëª©
   - ë§¤ì¶œì•¡ ë˜ëŠ” ë§¤ì¶œ ë¹„ì¤‘ì´ í•¨ê»˜ ê¸°ì¬ëœ ê²½ìš° ê°™ì´ ì¶”ì¶œ

2. ìˆ˜ì£¼ í˜„í™©:
   - 'ìˆ˜ì£¼ í˜„í™©', 'ìˆ˜ì£¼ ê³„ì•½', 'ìˆ˜ì£¼ ì”ê³ ' ë“±ì˜ ì„¹ì…˜
   - ê³„ì•½ì¼ì, ê³„ì•½ì²˜, ê³„ì•½ë‚´ìš©, ê³„ì•½ê¸ˆì•¡, ë‚©ê¸°ì¼, ê¸°ë‚©í’ˆì•¡, ìˆ˜ì£¼ì”ê³  ë“± ì •ë³´

3. ìˆ˜ì£¼ í˜„í™© ë¶„ê¸°ë³„ ì¦ê°ìœ¨:
   - ìˆ˜ì£¼ ì”ê³ ì— ëŒ€í•œ ë¶„ê¸°ë³„ ì¦ê°ë¥ (QoQ)
   - ë³´ê³ ì„œì— ì§ì ‘ì ì¸ ì–¸ê¸‰ì´ ì—†ìœ¼ë©´ ë°ì´í„°ë¡œ ê³„ì‚° (ê°€ëŠ¥ ì—¬ë¶€ ëª…ì‹œ)

4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™© ë° ì¦ê°ìœ¨:
   - 'ì‚¬ì—… ë¶€ë¬¸ë³„ í˜„í™©', 'ë¶€ë¬¸ë³„ ì¬ë¬´ ì •ë³´' ë“±ì—ì„œ ê° ì‚¬ì—…ë¶€ë¬¸ì˜ ë§¤ì¶œì•¡
   - ë¶„ê¸°ë³„ ì¦ê°ë¥ (QoQ) (ê³„ì‚° ê°€ëŠ¥ ì—¬ë¶€ ëª…ì‹œ)

5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™© ë° ì¦ê°ìœ¨:
   - 'ì£¼ìš” ì œí’ˆ ë° ì„œë¹„ìŠ¤', 'ë§¤ì¶œ ì‹¤ì ' ë“±ì—ì„œ ì œí’ˆë³„ ë§¤ì¶œì•¡
   - ë¶„ê¸°ë³„ ì¦ê°ë¥ (QoQ) (ê³„ì‚° ê°€ëŠ¥ ì—¬ë¶€ ëª…ì‹œ)

6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™© ë° ì¦ê°ìœ¨:
   - 'ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©', 'ìˆ˜ì¶œ/ë‚´ìˆ˜ ë¹„ì¤‘' ë“±ì—ì„œ ì§€ì—­ë³„ ë§¤ì¶œì•¡
   - ë¶„ê¸°ë³„ ì¦ê°ë¥ (QoQ) (ê³„ì‚° ê°€ëŠ¥ ì—¬ë¶€ ëª…ì‹œ)

7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘:
   - ì „ì²´ ë§¤ì¶œì•¡ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ë¬¸ì˜ ë¹„ìœ¨(%)
   - ì§ì ‘ì ì¸ ì–¸ê¸‰ì´ ì—†ìœ¼ë©´ ë°ì´í„°ë¡œ ê³„ì‚° (ê°€ëŠ¥ ì—¬ë¶€ ëª…ì‹œ)

ë³´ê³ ì„œì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš°, í•´ë‹¹ í•­ëª©ì€ "ì •ë³´ ì—†ìŒ" ë˜ëŠ” "ê³„ì‚° ë¶ˆê°€"ë¡œ í‘œì‹œí•˜ì„¸ìš”.
ê³„ì‚°ì´ í•„ìš”í•œ ê²½ìš° ê·¼ê±°ê°€ ë˜ëŠ” ìˆ˜ì¹˜ì™€ ê³„ì‚° ê³¼ì •ì„ í•¨ê»˜ ì œì‹œí•˜ì„¸ìš”.
ëª¨ë“  ê¸ˆì•¡ì—ëŠ” ì ì ˆí•œ ë‹¨ìœ„(ì–µì›, ë°±ë§Œì› ë“±)ë¥¼ ëª…ì‹œí•˜ì„¸ìš”.
"""

REVENUE_BREAKDOWN_SYSTEM_PROMPT2 = """
ë‹¹ì‹ ì€ ê¸°ì—… ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì‚¬ì—…ë³´ê³ ì„œ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì •ë³´ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”:

1. ì£¼ìš” ë§¤ì¶œì²˜ (ì£¼ìš” ê±°ë˜ì²˜, ì£¼ìš” ê³ ê°)
2. ìˆ˜ì£¼ í˜„í™© (ê³„ì•½, ìˆ˜ì£¼ ì”ê³  ë“±)
3. ìˆ˜ì£¼ í˜„í™©ì˜ ë¶„ê¸°ë³„ ì¦ê°ìœ¨ í˜„í™©
4. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ í˜„í™©ê³¼ ì§€ë‚œ ë¶„ê¸° ëŒ€ë¹„ ì¦ê°ìœ¨(QoQ)
5. ì œí’ˆë³„ ë§¤ì¶œ í˜„í™©ê³¼ ì§€ë‚œ ë¶„ê¸° ëŒ€ë¹„ ì¦ê°ìœ¨(QoQ)
6. ì§€ì—­ë³„ ë§¤ì¶œ í˜„í™©ê³¼ ì§€ë‚œ ë¶„ê¸° ëŒ€ë¹„ ì¦ê°ìœ¨(QoQ)
7. ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ì „ì²´ ë§¤ì¶œ ëŒ€ë¹„ ê° ì‚¬ì—…ë¶€ì˜ ë¹„ìœ¨, %)

**ìš”ì²­ ì‚¬í•­:**
- ìœ„ ì •ë³´ë¥¼ ê°„ê²°í•œ **í‘œ** í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.
- ì •ë³´ê°€ ì—†ëŠ” í•­ëª©ì€ ìƒëµí•©ë‹ˆë‹¤.
- í•­ëª© 4~6ë²ˆì€ ê°ê° ë³„ë„ì˜ í‘œë¡œ êµ¬ë¶„í•˜ì—¬ ì‘ì„±í•´ì£¼ì„¸ìš”.
- í•­ëª© 7ë²ˆì€ í•­ëª© 4ë²ˆì˜ ë§¤ì¶œì„ ê¸°ë°˜ìœ¼ë¡œ ë¹„ì¤‘ì„ ê³„ì‚°í•´ì£¼ì„¸ìš”.
- 4~6ë²ˆ í‘œëŠ” ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•´ì£¼ì„¸ìš”:

[ğŸ“Š í‘œ ì˜ˆì‹œ: ì œí’ˆë³„ ë§¤ì¶œ]

| ë¶„ê¸° | ë‚˜ë™ì„  | ì•Œë£¨ë¯¸ëŠ„ | ë‚´ìˆ˜ |
|------|--------|-----------|--------|
| 2024ë…„ 1ë¶„ê¸° | 470,626 (5.2%) | 220,000 (2.1%) | 110,000 (3.5%) |
| 2024ë…„ 2ë¶„ê¸° | 667,098 (11.3%) | 250,000 (13.6%) | 130,000 (18.2%) |
| 2024ë…„ 3ë¶„ê¸° | 911,377 (10.1%) | 285,000 (9.2%) | 150,000 (15.4%) |

[ğŸ“ˆ í‘œ ì˜ˆì‹œ: ì‚¬ì—…ë¶€ë¬¸ë³„ ë§¤ì¶œ ë¹„ì¤‘]

| ë¶„ê¸° | ì „ì„  | ì¤‘ì „ê¸° | ê¸°íƒ€ |
|------|------|--------|------|
| 2024ë…„ 1ë¶„ê¸° | 65.2% | 32.5% | 2.3% |
| 2024ë…„ 2ë¶„ê¸° | 66.1% | 31.4% | 2.5% |
| 2024ë…„ 3ë¶„ê¸° | 67.3% | 30.1% | 2.6% |

â€» ëª¨ë“  ê¸ˆì•¡ ë‹¨ìœ„ëŠ” **ë°±ë§Œì›**, ê´„í˜¸ ì•ˆì€ ì „ ë¶„ê¸° ëŒ€ë¹„ ì¦ê°ìœ¨(QoQ)ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œ ë¹„ì¤‘(%)ì€ ê° ë¶„ê¸° ì´ ë§¤ì¶œ ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ëœ ë¹„ìœ¨ì…ë‹ˆë‹¤.
â€» ë§¤ì¶œì•¡ì´ ì—†ëŠ” í•­ëª©ì€ â€˜-â€™ë¡œ í‘œê¸°í•´ì£¼ì„¸ìš”.
"""

def format_revenue_breakdown_data(formatted_data: List[Dict[str, Any]]) -> str:
    """ì¬ë¬´ ë°ì´í„°ë¥¼ ë¬¸ìì—´ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.

    Args:
        financial_data: ì¬ë¬´ ë°ì´í„° ë¦¬ìŠ¤íŠ¸

    Returns:
        str: í¬ë§·íŒ…ëœ ì¬ë¬´ ë°ì´í„° ë¬¸ìì—´
    """
    if not formatted_data:
        print("[FIN_FORMAT] ì…ë ¥ ë°ì´í„°ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.")
        return "ì¬ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    # ì›ë³¸ ë°ì´í„° ë³´ì¡´ì„ ìœ„í•´ ë³µì‚¬ë³¸ ìƒì„±
    result_strings = []
    
    for idx, item in enumerate(formatted_data):
            
        # ë¬¸ìì—´ì¸ ê²½ìš° ê·¸ëŒ€ë¡œ ì¶”ê°€
        if isinstance(item, str):
            result_strings.append(item)
            continue
            
        # ë”•ì…”ë„ˆë¦¬ê°€ ì•„ë‹Œ ê²½ìš° ê±´ë„ˆë›°ê¸°
        if not isinstance(item, dict):
            print(f"[FIN_FORMAT] ê²½ê³ : ì˜ëª»ëœ ë°ì´í„° íƒ€ì…: {type(item)} (ì¸ë±ìŠ¤ {idx})")
            continue
            
        # í•„ìš”í•œ ê°’ ì¶”ì¶œ
        source = item.get("source", "ì•Œ ìˆ˜ ì—†ëŠ” ì¶œì²˜")
        date = item.get("date", "ë‚ ì§œ ì—†ìŒ")
        content = item.get("content", "")
        indicators = item.get("financial_indicators", {})
        
        data_str = f"[ì¶œì²˜: {source} ({date})]\n"
        
        # ì£¼ìš” ì¬ë¬´ ì§€í‘œê°€ ìˆìœ¼ë©´ ë¨¼ì € í‘œì‹œ
        if indicators:
            data_str += "\n## ì£¼ìš” ì¬ë¬´ ì§€í‘œ ê´€ë ¨ í…ìŠ¤íŠ¸:\n"
            for key, value in indicators.items():
                data_str += f"\n### {key}:\n{value}\n"
        
        # ë³´ê³ ì„œ ë‚´ìš© ì¶”ê°€
        data_str += f"\n## ë³´ê³ ì„œ ë³¸ë¬¸:\n{content}\n"
        
        # ê²°ê³¼ ë¬¸ìì—´ ëª©ë¡ì— ì¶”ê°€ (ì›ë³¸ ë°ì´í„°ë¥¼ ë³€ê²½í•˜ì§€ ì•ŠìŒ)
        result_strings.append(data_str)
    
    print(f"[FIN_FORMAT] ê²°ê³¼ ë¬¸ìì—´ ìˆ˜: {len(result_strings)}")
    result = "\n\n===== ë³´ê³ ì„œ êµ¬ë¶„ì„  =====\n\n".join(result_strings)
    print(f"[FIN_FORMAT] ë°˜í™˜ë˜ëŠ” ìµœì¢… ë¬¸ìì—´ ê¸¸ì´: {len(result)}")
    
    # ëª¨ë“  í¬ë§·íŒ…ëœ ë¬¸ìì—´ì„ êµ¬ë¶„ì„ ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ë°˜í™˜
    return result
